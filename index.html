<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Generador de Evaluaciones</title>
    
    <!-- OPTIMIZACI√ìN DE CONEXI√ìN -->
    <link rel="preconnect" href="https://docs.google.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- FAVICON (Icono de examen/checklist) -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect x=%2215%22 y=%2210%22 width=%2270%22 height=%2280%22 rx=%225%22 fill=%22%23FFFFFF%22 stroke=%22%231B4965%22 stroke-width=%224%22/%3E%3Cpath d=%22M30 30 L40 40 L70 20%22 fill=%22none%22 stroke=%22%23e74c3c%22 stroke-width=%225%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22/%3E%3Crect x=%2230%22 y=%2250%22 width=%2240%22 height=%224%22 fill=%22%233A9D9D%22 rx=%222%22/%3E%3Crect x=%2230%22 y=%2265%22 width=%2240%22 height=%224%22 fill=%22%233A9D9D%22 rx=%222%22/%3E%3C/svg%3E">

    <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Chewy&family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- LIBRER√çAS -->
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.49.1/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/json5@2/dist/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'],
                        montserrat: ['Montserrat', 'sans-serif'],
                        chewy: ['Chewy', 'cursive']
                    },
                    colors: {
                        montessori: {
                            blue: '#1B4965',
                            teal: '#3A9D9D',
                            red: '#e74c3c',
                            yellow: '#FFC857',
                            gray: '#F3F4F6',
                            lightBlue: '#E0EFFF'
                        }
                    },
                    boxShadow: {
                        'card-hover': '0 15px 30px -5px rgba(0, 0, 0, 0.08), 0 10px 12px -6px rgba(0, 0, 0, 0.02)',
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.03)'
                    },
                    animation: {
                        'diagonal-shift': 'diagonalShift 3s ease-in-out infinite alternate',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'teal-yellow-cycle': 'tealYellowCycle 3s infinite cubic-bezier(0.4, 0, 0.2, 1)', 
                    },
                    keyframes: {
                        diagonalShift: {
                            '0%': { 'background-position': '0% 0%' },
                            '100%': { 'background-position': '100% 100%' },
                        },
                        tealYellowCycle: {
                            '0%, 100%': { color: '#1B4965' },
                            '50%': { color: '#FFC857' }
                        },
                        successFeedback: {
                            '0%': { transform: 'scale(1)', opacity: 1 },
                            '50%': { transform: 'scale(1.05)', opacity: 0.8 },
                            '100%': { transform: 'scale(1)', opacity: 1 },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* CONTROL DE LAYOUT PRINCIPAL */
        body { 
            background-color: #f8fafc; 
            height: 100vh; 
            width: 100vw;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        /* --- SCROLL INVISIBLE GLOBAL --- */
        *::-webkit-scrollbar {
            display: none;
            width: 0 !important;
            height: 0 !important;
        }

        * {
            -ms-overflow-style: none;
            scrollbar-width: none;
            touch-action: manipulation;
        }

        .custom-scroll { 
            overflow-y: auto;
        }

        /* --- FONDO ANIMADO --- */
        .particles-container {
            position: absolute;
            inset: 0;
            overflow: hidden;
            pointer-events: none;
            z-index: 0;
        }

        .grade-particle {
            position: absolute;
            font-family: 'Montserrat', sans-serif;
            font-weight: 900; 
            opacity: 0;
            user-select: none;
            text-shadow: 0 2px 4px rgba(255,255,255,0.5); 
        }

        .grade-particle.primary-teal { color: rgba(27, 73, 101, 0.25); }
        .grade-particle.secondary-teal { color: rgba(58, 157, 157, 0.25); }

        .grade-particle.background {
            animation: floatUp linear infinite;
        }

        @keyframes floatUp {
            0% { transform: translateY(110vh) scale(0.8) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-10vh) scale(1.1) rotate(var(--rotation)); opacity: 0; }
        }

        .grid-overlay {
            position: absolute;
            inset: 0;
            background-image: 
                linear-gradient(rgba(27, 73, 101, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(27, 73, 101, 0.02) 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: 0;
        }

        .animated-diagonal-background {
            background: repeating-linear-gradient(
                45deg, 
                #E0EFFF 0%, 
                #E0EFFF 40%, 
                #E0EFFF 60%, 
                #E0EFFF 100%
            );
            background-size: 200vw 200vh;
            animation: diagonalShift 3s ease-in-out infinite alternate; 
            position: absolute; 
            inset: 0;
            z-index: 0;
            will-change: background-position, transform; 
        }

        /* Estilos del Editor Manual */
        .plan-card {
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-bottom: 1.25rem;
            background-color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
        }
        .plan-card:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        .day-header {
            color: #1B4965;
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 1rem;
            border-bottom: 2px solid #E0EFFF;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
        }
        
        .section-label {
            display: block;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            color: #64748b;
            margin-bottom: 0.3rem;
            letter-spacing: 0.05em;
            margin-top: 1rem;
        }
        .section-label:first-of-type { margin-top: 0; }

        .editable-field {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            font-size: 16px; 
            line-height: 1.5;
            color: #334155;
            background-color: #f8fafc;
            transition: all 0.2s;
            resize: none;
            outline: none;
        }

        @media (min-width: 768px) {
            .editable-field { font-size: 0.875rem; }
        }
        
        .editable-field:focus {
            background-color: #ffffff;
            border-color: #1B4965;
            box-shadow: 0 0 0 3px rgba(27, 73, 101, 0.1);
        }
        
        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }

        /* --- ANIMACIONES GENERALES --- */
        
        @keyframes colorPulseFooter {
            0% { color: #4B5563; }
            33% { color: #FFC857; }
            66% { color: #1B4965; }
            100% { color: #4B5563; }
        }
        
        .animate-pulse-color { 
            animation: colorPulseFooter 4s ease-in-out infinite !important; 
        }
        
        .fade-out { animation: fadeOut 0.4s ease-out forwards; }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.99); pointer-events: none; } }
        
        .loader {
            border: 3px solid rgba(255,255,255,0.3); 
            border-radius: 50%; 
            border-top: 3px solid #ffffff;
            width: 20px; 
            height: 20px; 
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #btn-login { min-height: 48px; }
        #btn-text { transition: opacity 0.3s; }
        #btn-text.hidden-text { opacity: 0; }

        @keyframes tealYellowCycle {
            0%, 100% { color: #1B4965; }
            50% { color: #FFC857; }
        }
        .animate-teal-yellow-cycle { animation: tealYellowCycle 3s infinite cubic-bezier(0.4, 0, 0.2, 1); }

        .animate-success-feedback {
            animation: successFeedback 0.3s ease-in-out;
        }

        /* CUSTOM SELECT STYLES */
        .custom-select-container { position: relative; width: 100%; }
        .custom-select-trigger { 
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; padding: 0.625rem 1rem; 
            background-color: #ffffff; border: 1px solid #e5e7eb; border-radius: 0.5rem;
            font-size: 0.875rem; font-weight: 500; color: #1f2937;
            cursor: pointer; transition: all 0.2s;
        }
        .custom-select-trigger:hover { border-color: #1B4965; }
        
        .custom-dropdown-list {
            position: absolute; 
            top: 100%; 
            left: 0; 
            right: 0;
            background-color: white; 
            border: 1px solid #e5e7eb; 
            border-radius: 0.5rem;
            margin-top: 4px; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 60; 
            max-height: 200px; 
            overflow-y: auto;
        }
        
        .custom-dropdown-list button {
            display: block;
            width: 100%;
            padding: 0.5rem 1rem; 
            text-align: left;
            font-size: 0.875rem; 
            color: #374151; 
            background: none;
            border: none;
            cursor: pointer;
            transition: background-color 0.15s;
        }
        
        .custom-dropdown-list button:hover { 
            background-color: #E0EFFF; 
            color: #1B4965; 
        }

        .day-btn.active {
            background-color: #1B4965;
            color: white; 
            border-color: #1B4965;
            box-shadow: 0 2px 5px rgba(27, 73, 101, 0.2);
        }

        /* Estilos deshabilitados */
        .disabled-btn {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(100%);
        }

    </style>
</head>
<body class="text-slate-800 font-sans antialiased">

    <!-- PRELOADER -->
    <div id="initial-loader" class="fixed inset-0 z-[300] flex items-center justify-center bg-montessori-lightBlue transition-all duration-700">
        <div class="animated-diagonal-background animate-diagonal-shift"></div>
        <div class="particles-container z-10"><div class="grid-overlay"></div></div>
        <div class="relative z-20 flex flex-col items-center justify-center">
            <h1 class="text-5xl md:text-7xl font-bold font-montserrat animate-teal-yellow-cycle drop-shadow-sm text-center leading-tight">Cargando...</h1>
        </div>
    </div>
    
    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-[100] flex items-center justify-center bg-montessori-lightBlue overflow-hidden transition-all duration-700">
        <div class="animated-diagonal-background animate-diagonal-shift"></div>
        <div class="particles-container z-10"><div class="grid-overlay"></div></div>
        
        <div id="login-card" class="relative z-20 w-full max-w-3xl mx-4 transition-all duration-700">
            <div class="bg-white/90 backdrop-blur-xl border border-white/50 rounded-3xl shadow-2xl overflow-hidden flex flex-col md:flex-row min-h-[380px]">
                <div class="w-full md:w-5/12 bg-montessori-blue flex flex-col items-center justify-center p-6 border-b md:border-b-0 md:border-r border-montessori-blue gap-4">
                    <h1 class="text-2xl md:text-4xl font-extrabold text-white font-montserrat text-center leading-snug tracking-tight">
                        Generador de Evaluaciones
                    </h1>
                    <p class="text-sm text-white/90 font-medium text-center mt-2">Herramienta de Dise√±o Curricular</p>
                </div>
                <div class="w-full md:w-7/12 p-6 md:p-8 flex flex-col justify-center">
                    <form id="login-form" onsubmit="handleLogin(event)" class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 uppercase tracking-wider mb-1.5">Credenciales de Acceso</label>
                            <div class="space-y-3">
                                <div class="relative group z-20">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <svg class="w-4 h-4 text-gray-600 group-focus-within:text-montessori-blue transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                    </div>
                                    <input type="text" id="username" required class="w-full pl-10 pr-4 py-2.5 rounded-lg bg-white border border-gray-200 text-gray-800 focus:bg-white focus:border-montessori-blue focus:ring-2 focus:ring-montessori-blue/20 outline-none transition-all duration-500 text-base md:text-sm placeholder-gray-600" placeholder="Usuario">
                                </div>
                                <div class="relative group z-20">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <svg class="w-4 h-4 text-gray-600 group-focus-within:text-montessori-blue transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                                    </div>
                                    <input type="password" id="password" required class="w-full pl-10 pr-4 py-2.5 rounded-lg bg-white border border-gray-200 text-gray-800 focus:bg-white focus:border-montessori-blue focus:ring-2 focus:ring-montessori-blue/20 outline-none transition-all duration-500 text-base md:text-sm placeholder-gray-600" placeholder="Contrase√±a">
                                </div>
                            </div>
                        </div>
                        <div id="login-status-container" class="min-h-[40px] transition-all duration-300 rounded-lg flex items-center justify-center gap-2 border border-transparent text-center px-2 py-1 bg-gray-50">
                             <span id="login-status-text" class="text-xs font-medium text-gray-600">Ingrese sus credenciales para continuar</span>
                        </div>
                        <button type="submit" id="btn-login" class="relative w-full bg-montessori-blue text-white font-bold text-sm py-3 rounded-lg shadow-lg shadow-montessori-blue/30 hover:bg-[#123145] hover:shadow-montessori-blue/50 hover:scale-[1.01] active:scale-[0.99] transition-all duration-300 flex justify-center items-center">
                            <span id="btn-text">Iniciar Sesi√≥n</span>
                            <div id="btn-loader" class="loader hidden absolute w-5 h-5 border-2"></div>
                        </button>
                    </form>
                    <div class="mt-4 text-center">
                        <a href="https://mail.google.com/mail/?view=cm&fs=1&to=christopherjcorderoe@gmail.com" target="_blank" class="text-[10px] text-gray-600 hover:text-montessori-blue transition-colors font-medium inline-flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                            Soporte T√©cnico
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE CUPO EXCEDIDO (EST√ÅTICO Y SIN ANIMACI√ìN) -->
    <div id="quota-exceeded-modal" class="hidden fixed inset-0 z-[220] flex items-center justify-center bg-black/60 backdrop-blur-md">
        <!-- Eliminadas transiciones y animaciones para hacerlo est√°tico -->
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-md w-full mx-4 border-2 border-red-100">
            <div class="text-center">
                <!-- Icono est√°tico (sin animate-bounce) -->
                <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full bg-red-100 mb-6">
                    <svg class="h-10 w-10 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <h3 class="text-2xl font-black text-gray-800 mb-2">¬°L√≠mite Mensual Alcanzado!</h3>
                <p class="text-sm text-gray-500 font-medium mb-6">Has agotado tus generaciones de este mes.</p>
                
                <div class="bg-red-50 p-4 rounded-xl border border-red-100 mb-6 text-left">
                    <p class="text-xs text-red-800 font-semibold mb-2">üö´ Restricciones Activadas:</p>
                    <ul class="text-xs text-red-700 list-disc list-inside space-y-1">
                        <li>No puedes generar nuevos planes.</li>
                        <li>No puedes modificar planes existentes.</li>
                        <li>El acceso se restablecer√° el: <strong id="reset-date-display" class="text-red-900"></strong>.</li>
                    </ul>
                </div>

                <!-- Bot√≥n que ejecuta logout inmediatamente -->
                <button type="button" onclick="logout()" class="w-full inline-flex justify-center items-center rounded-xl shadow-lg px-4 py-3 bg-gray-800 text-white font-bold hover:bg-gray-900 transition-colors">
                    Entendido
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODAL INSTRUCCIONES MEJORADO -->
    <div id="instructions-modal" class="hidden fixed inset-0 z-[250] flex items-center justify-center bg-black/40 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-4xl w-full mx-4 border border-gray-100 flex flex-col h-[85vh] transition-all transform duration-300">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-100 flex-shrink-0">
                <h3 class="text-lg font-bold text-montessori-blue font-montserrat flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                    Contexto Extra
                </h3>
                <button onclick="toggleInstructionsModal()" class="text-gray-400 hover:text-montessori-red transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="flex-1 flex flex-col md:flex-row gap-6 overflow-hidden">
                <!-- Columna Izquierda: Instrucciones -->
                <div class="flex-1 flex flex-col overflow-hidden">
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Instrucciones Adicionales</label>
                    <textarea id="instructions-input" class="w-full flex-1 p-4 rounded-xl bg-gray-50 border border-gray-200 text-sm focus:border-montessori-blue focus:ring-2 focus:ring-montessori-lightBlue outline-none resize-none transition-all" placeholder="Ej: Haz √©nfasis en la ecolog√≠a, evita preguntas sobre fechas..."></textarea>
                </div>

                <!-- Columna Derecha: Archivos -->
                <div class="flex-1 flex flex-col overflow-hidden border-t md:border-t-0 md:border-l border-gray-100 pt-4 md:pt-0 md:pl-6">
                    <div class="flex justify-between items-end mb-2 flex-shrink-0">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Archivos de Contexto (PDF/Word)</label>
                        <span id="img-count" class="text-[10px] text-gray-400 font-medium">0/12</span>
                    </div>
                    
                    <input type="file" id="image-upload" accept="image/*,.pdf,.docx" multiple class="hidden" onchange="handleFileUpload(event)">
                    
                    <div id="upload-area" class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center hover:bg-gray-50 transition-colors cursor-pointer flex-shrink-0" onclick="document.getElementById('image-upload').click()">
                        <div class="text-gray-400 flex flex-col items-center gap-2">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            <span class="text-xs font-medium">Adjuntar Archivos</span>
                        </div>
                    </div>

                    <div id="images-grid" class="hidden grid grid-cols-2 lg:grid-cols-3 gap-2 mt-3 overflow-y-auto custom-scroll pr-1"></div>
                    <div id="docs-list" class="mt-2 space-y-1 overflow-y-auto max-h-[100px] custom-scroll"></div>
                </div>
            </div>

            <div class="mt-4 flex justify-end gap-3 pt-3 border-t border-gray-100 flex-shrink-0">
                <button onclick="toggleInstructionsModal()" class="px-4 py-2 text-sm text-gray-600 font-medium hover:bg-gray-100 rounded-lg transition-colors">Cancelar</button>
                <button onclick="saveInstructions()" class="px-6 py-2 bg-montessori-blue text-white text-sm font-bold rounded-lg hover:bg-[#123145] transition-colors shadow-lg shadow-montessori-blue/30">Guardar Cambios</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL DE COMENTARIOS / MODIFICACI√ìN (NUEVO) -->
    <div id="modification-modal" class="hidden fixed inset-0 z-[260] flex items-center justify-center bg-black/40 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-4xl w-full mx-4 border border-gray-100 flex flex-col h-[60vh] md:h-[50vh] transition-all transform duration-300">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-100 flex-shrink-0">
                <h3 class="text-lg font-bold text-montessori-blue font-montserrat flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    Modificar Evaluaci√≥n Actual
                </h3>
                <button onclick="toggleModificationModal()" class="text-gray-400 hover:text-montessori-red transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="flex-1 flex flex-col gap-2">
                <p class="text-xs text-gray-500 font-medium">Describe qu√© cambios quieres hacer a la evaluaci√≥n visible (ej: "Haz el ejercicio 2 m√°s dif√≠cil" o "Cambia el tipo de pregunta del ejercicio 1"). <span class="text-montessori-red font-bold">Consume 1 uso.</span></p>
                <textarea id="modification-input" class="w-full flex-1 p-4 rounded-xl bg-gray-50 border border-gray-200 text-sm focus:border-montessori-blue focus:ring-2 focus:ring-montessori-lightBlue outline-none resize-none transition-all" placeholder="Solicita cambios espec√≠ficos..."></textarea>
            </div>

            <div class="mt-4 flex justify-end gap-3 pt-3 border-t border-gray-100 flex-shrink-0">
                <button onclick="toggleModificationModal()" class="px-4 py-2 text-sm text-gray-600 font-medium hover:bg-gray-100 rounded-lg transition-colors">Cancelar</button>
                <button onclick="applyModification()" class="px-6 py-2 bg-montessori-blue text-white text-sm font-bold rounded-lg hover:bg-[#123145] transition-colors shadow-lg shadow-montessori-blue/30">Aplicar Cambios</button>
            </div>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="app-content" class="hidden flex flex-col h-screen w-full relative z-0 opacity-0 transition-opacity duration-1000 overflow-hidden">
        
        <!-- Fondo -->
        <div class="fixed inset-0 z-0">
            <div class="animated-diagonal-background"></div>
            <div class="particles-container z-10"><div class="grid-overlay"></div></div>
        </div>

        <!-- HEADER -->
        <header class="bg-white/90 backdrop-blur-sm border-b border-gray-200 sticky top-0 z-50 h-16 flex-shrink-0 w-full shadow-sm">
            <div class="w-full px-6 h-full flex justify-between items-center">
                <div class="flex items-center cursor-pointer" onclick="location.reload()">
                     <h1 class="text-lg font-bold text-montessori-blue font-montserrat">Generador de Evaluaciones</h1>
                </div>
                
                <div class="flex items-center gap-4">
                    <div class="flex flex-col items-center mr-2">
                         <div class="flex items-center gap-1">
                             <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest leading-tight">Hola,</span>
                             <span id="user-name-display" class="text-xs font-black text-montessori-blue leading-tight max-w-[150px] truncate text-right">Usuario</span>
                         </div>
                         <div class="bg-montessori-lightBlue px-3 py-1 rounded-lg mt-1 border border-montessori-lightBlue/50 flex items-center justify-center gap-2 h-6" id="quota-badge">
                             <span class="text-[9px] font-bold text-slate-500 uppercase leading-none">Usos mes:</span>
                             <span id="usage-counter" class="text-xs font-black text-montessori-blue leading-none pt-[1px]">...</span>
                         </div>
                    </div>
                    <button onclick="logout()" class="p-2 text-montessori-red/70 hover:text-montessori-red hover:bg-red-50 rounded-full transition-colors" title="Cerrar Sesi√≥n">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- MAIN CONTENT -->
        <main class="flex-1 w-full relative z-10 overflow-hidden flex flex-col md:flex-row p-4 md:p-6 gap-6 min-h-0">
            
            <!-- PANEL IZQUIERDO: CONFIGURACI√ìN -->
            <div class="w-full md:w-1/4 flex flex-col gap-4 overflow-y-auto custom-scroll pr-1 pb-20 md:pb-0 h-full flex-shrink-0">
                <div class="bg-white/95 backdrop-blur rounded-2xl p-4 border border-white shadow-soft hover:shadow-card-hover transition-all duration-300 flex flex-col h-full overflow-y-auto custom-scroll">
                    <!-- HEADER COMPACTO -->
                    <div class="flex items-center gap-2 mb-3 pb-2 border-b border-gray-100 pb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-montessori-blue" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                        <h2 class="text-sm font-bold text-slate-800 font-montserrat">Configuraci√≥n Examen</h2>
                    </div>

                    <form id="plannerForm" class="space-y-2 flex-1 flex flex-col" onsubmit="generatePlan(event)">
                        
                        <!-- FILA 1: ASIGNATURA Y CURSO -->
                        <div class="flex gap-2">
                             <div class="w-1/2">
                                <label class="block text-xs font-bold text-gray-600 uppercase tracking-wider mb-1.5">Asignatura</label>
                                <input type="text" id="subject" placeholder="Ej: Biolog√≠a" required class="w-full px-3 py-2 rounded-lg bg-gray-50 border border-gray-200 text-gray-800 focus:bg-white focus:border-montessori-blue text-base md:text-sm font-medium">
                            </div>
                            <div class="w-1/2">
                                <label class="block text-xs font-bold text-gray-600 uppercase tracking-wider mb-1.5">Curso / Nivel</label>
                                <input type="text" id="groupDetails" placeholder="Ej: 1¬∫ de Secundaria" required class="w-full px-3 py-2 rounded-lg bg-gray-50 border border-gray-200 text-gray-800 focus:bg-white focus:border-montessori-blue text-base md:text-sm font-medium">
                            </div>
                        </div>

                        <!-- FILA 2: TONO Y TIPO DE EJERCICIO -->
                        <div class="flex gap-2">
                            <!-- SELECT TONO/LENGUAJE -->
                            <div class="relative custom-select-container w-1/2">
                                <label class="block text-xs font-bold text-gray-600 uppercase tracking-wider mb-1.5">Tono</label>
                                <div id="style-dropdown-btn" class="custom-select-trigger h-[35px] py-1" onclick="toggleDropdown('style')">
                                    <span id="selected-style-text" class="text-gray-500 font-normal text-xs">Seleccionar...</span>
                                    <svg class="h-4 w-4 text-gray-600 transform transition-transform duration-200" id="style-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                                </div>
                                <div id="style-dropdown-list" class="custom-dropdown-list hidden">
                                    <button type="button" onclick="selectDropdownValue('style', 'T√©cnico')">T√©cnico</button>
                                    <button type="button" onclick="selectDropdownValue('style', 'Acad√©mico')">Acad√©mico</button>
                                    <button type="button" onclick="selectDropdownValue('style', 'Simple y Directo')">Simple y Directo</button>
                                    <button type="button" onclick="selectDropdownValue('style', 'Formal')">Formal</button>
                                    <button type="button" onclick="selectDropdownValue('style', 'Accesible')">Accesible (Adaptado)</button>
                                </div>
                                <input type="hidden" id="teachingStyle" value="">
                            </div>

                             <div class="w-1/2">
                                 <label class="block text-xs font-bold text-gray-600 uppercase tracking-wider mb-1.5">Tipos de Ejercicio</label>
                                 <input type="text" id="exerciseTypes" placeholder="Ej: Selecci√≥n, V/F" class="w-full px-3 py-2 rounded-lg bg-gray-50 border border-gray-200 text-gray-800 text-sm font-medium">
                             </div>
                        </div>

                        <!-- FILA 3: CANTIDAD DE EJERCICIOS E ITEMS -->
                        <div class="flex gap-2">
                             <div class="w-1/2">
                                <label class="block text-xs font-bold text-gray-600 uppercase tracking-wider mb-1.5">Total Ejercicios</label>
                                <input type="number" id="totalExercisesInput" value="4" min="1" max="20" required class="w-full px-3 py-2 rounded-lg bg-gray-50 border border-gray-200 text-gray-800 focus:bg-white focus:border-montessori-blue text-base md:text-sm font-medium text-center">
                                <p class="text-[9px] text-gray-400 mt-1 leading-tight text-center">M√°ximo: 20</p>
                            </div>
                             <div class="w-1/2">
                                 <label class="block text-xs font-bold text-gray-600 uppercase tracking-wider mb-1.5">√çtems/Ejercicio</label>
                                 <input type="number" id="itemsPerExercise" value="5" min="1" max="20" class="w-full px-3 py-2 rounded-lg bg-gray-50 border border-gray-200 text-gray-800 text-sm font-medium text-center">
                                 <p class="text-[9px] text-gray-400 mt-1 leading-tight text-center">Sub-preguntas por secci√≥n</p>
                             </div>
                        </div>

                        <!-- FILA 4: TEMAS A EVALUAR (√ÅREA GRANDE) -->
                        <div class="flex flex-col min-h-0">
                            <label class="block text-xs font-bold text-gray-600 uppercase tracking-wider mb-1.5">Temas a Evaluar</label>
                            <textarea id="topics" class="w-full h-12 px-3 py-2 rounded-lg bg-gray-50 border border-gray-200 text-gray-800 focus:bg-white focus:border-montessori-blue focus:ring-2 focus:ring-montessori-blue/20 outline-none transition-all duration-300 text-base md:text-sm font-medium resize-none" placeholder="Lista de temas..."></textarea>
                        </div>

                        <!-- EXPORTAR A WORD -->
                        <div class="border-t border-gray-100 pt-3 mt-1">
                            <label class="block text-xs font-bold text-montessori-blue uppercase tracking-wider mb-2 flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                Plantilla Word
                            </label>
                            <div class="relative">
                                <input type="file" id="template-upload" accept=".docx" class="hidden" onchange="handleTemplateSelect(event)">
                                <label for="template-upload" class="flex items-center justify-between w-full px-3 py-2 bg-montessori-lightBlue border border-montessori-lightBlue/50 rounded-lg cursor-pointer hover:bg-montessori-lightBlue/70 transition-colors">
                                    <span id="template-name" class="text-xs text-montessori-blue font-medium truncate max-w-[180px]">Cargar Plantilla (.docx)</span>
                                    <svg class="w-4 h-4 text-montessori-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                </label>
                            </div>
                            <p class="text-[9px] text-gray-400 mt-1 leading-tight">Usa: {consigna_1}, {contenido_1}, {consigna_2}...</p>
                        </div>
                        
                        <!-- BOT√ìN CONTEXTO Y GENERAR (SE MANTIENEN IGUAL) -->
                        <button type="button" id="btn-instructions" onclick="toggleInstructionsModal()" class="w-full py-2.5 px-3 rounded-lg bg-gray-50 border border-dashed border-gray-300 text-gray-600 hover:text-montessori-blue hover:border-montessori-blue hover:bg-montessori-lightBlue transition-all duration-300 flex items-center justify-center gap-2 group mt-1">
                            <span class="text-xs font-bold truncate" id="btn-instructions-text">Contexto / Archivos</span>
                            <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                        </button>
                        <input type="hidden" id="customInstructions" value="">

                        <!-- RECUADRO DE LIMITACIONES (NUEVO) -->
                        <div class="bg-yellow-50 border border-yellow-200 p-2 rounded-lg">
                            <p class="text-[10px] text-yellow-800 font-semibold flex items-center gap-1">
                                <svg class="w-3 h-3 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                CONSIDERACIONES IMPORTANTES
                            </p>
                            <ul class="text-[9px] text-yellow-700 list-disc list-inside space-y-0.5 ml-2 mt-1 leading-tight">
                                <li>M√°ximo de 20 ejercicios por generaci√≥n.</li>
                                <li>No genera im√°genes ni gr√°ficos; solo texto.</li>
                                <li>Las f√≥rmulas complejas se representan en formato de texto.</li>
                            </ul>
                        </div>
                        <!-- FIN RECUADRO DE LIMITACIONES -->

                        <button type="submit" id="btn-generate" class="group relative w-full bg-montessori-blue hover:bg-[#123145] text-white font-bold py-3.5 rounded-xl shadow-lg shadow-montessori-blue/30 transition-all duration-300 transform hover:-translate-y-0.5 active:translate-y-0 flex items-center justify-center gap-2 overflow-hidden">
                            <span class="relative z-10 flex items-center gap-2">GENERAR EVALUACI√ìN</span>
                            <div class="absolute inset-0 h-full w-full scale-0 rounded-2xl transition-all duration-300 group-hover:scale-100 group-hover:bg-white/10"></div>
                        </button>
                    </form>
                </div>
            </div>

            <!-- PANEL DERECHO: RESULTADOS (EDITOR MANUAL) -->
            <div class="w-full md:w-3/4 h-full flex flex-col relative min-h-0">
                
                <div id="result-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-center p-8 bg-white/50 backdrop-blur-sm border-2 border-dashed border-gray-300 rounded-2xl">
                    <div class="w-20 h-20 bg-montessori-lightBlue rounded-full flex items-center justify-center mb-4 animate-pulse-slow">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-montessori-blue" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    </div>
                    <h3 class="text-xl font-bold text-gray-700 font-montserrat mb-2">Editor de Evaluaciones</h3>
                    <p class="text-gray-500 text-sm max-w-sm">Configura los par√°metros a la izquierda y genera un examen completo, listo para imprimir.</p>
                </div>

                <div id="loader" class="hidden absolute inset-0 z-20 flex items-center justify-center bg-white/90 backdrop-blur-sm rounded-2xl transition-all duration-300">
                    <div class="flex flex-col items-center">
                        <div class="relative w-20 h-20 mb-6">
                            <div class="absolute inset-0 rounded-full border-4 border-gray-100"></div>
                            <div class="absolute inset-0 rounded-full border-4 border-montessori-teal border-t-transparent animate-spin"></div>
                            <div class="absolute inset-3 rounded-full border-4 border-montessori-blue border-t-transparent animate-spin" style="animation-direction: reverse; animation-duration: 2s;"></div>
                        </div>
                        <div class="text-center space-y-2">
                            <h3 class="text-lg font-bold text-montessori-blue font-montserrat animate-pulse">Dise√±ando Examen...</h3>
                            <p class="text-xs text-gray-500 font-medium">Redactando preguntas y consignas...</p>
                        </div>
                    </div>
                </div>

                <!-- Contenedor de Resultados con Editor -->
                <div id="result-content" class="hidden h-full flex-col bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100 relative z-10 transition-all duration-500 transform translate-y-4 opacity-0 flex-1">
                    
                    <div class="flex justify-between items-center px-4 py-2 bg-gray-50 border-b border-gray-200 flex-shrink-0 h-14">
                        <div class="flex items-center gap-2">
                             <div class="flex flex-col">
                                <span class="text-sm font-bold text-gray-700">Vista Previa del Examen</span>
                                <span class="text-[10px] text-gray-500">Puedes editar el texto antes de exportar</span>
                             </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <!-- BOT√ìN DE MODIFICACI√ìN (NUEVO) -->
                            <button id="btn-modify" onclick="toggleModificationModal()" class="hidden flex items-center gap-2 px-3 py-1.5 bg-montessori-yellow text-slate-800 rounded-lg hover:bg-yellow-400 shadow-md transition-all font-bold text-xs">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                CORREGIR / MODIFICAR
                            </button>
                            <button id="btn-download-word" onclick="downloadWord()" class="hidden flex items-center gap-2 px-4 py-1.5 bg-montessori-teal text-white rounded-lg hover:bg-[#288B8B] shadow-md transition-all font-bold text-xs">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                DESCARGAR WORD
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto custom-scroll p-6 bg-gray-50/50" id="editor-container">
                        <!-- AQU√ç SE INYECTAR√ÅN LOS EJERCICIOS (JS) -->
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="bg-white/90 backdrop-blur-sm border-t border-gray-200 py-4 mt-auto flex-shrink-0 w-full z-10">
            <div class="text-center text-[10px] sm:text-xs text-gray-600">
                <a href="https://chrisjocoes21.github.io/PORTAFOLIO/" target="_blank" class="animate-pulse-color font-medium transition-colors hover:text-montessori-blue hover:underline" title="Visitar Portafolio">
                    ¬© 2025 Generador Acad√©mico - Desarrollado por Didac-Click Group.
                </a>
            </div>
        </footer>
    </div>

    <div class="h-4"></div>
    <div id="toast"></div>

    <script>
        // --- API CONFIGURATION ---
        const API_URL = "https://script.google.com/macros/s/AKfycbwb0EpW1cPVSfOXj3XE0GR5t443XLelKb4gPNtW69IYN_EoehMli0rtMbSaodqEOeo0/exec";
        const API_GEN_URL = "https://script.google.com/macros/s/AKfycbyYTp9lY07wCjxtwMrFZth_78nJm02gUyTK1V72Ngab9VHbChYAzzteBEUy4VzOZCcGWw/exec";
        
        // --- GLOBAL STATE ---
        let currentUser = null;
        let userQuota = { remaining: 0, total: 0 };
        let attachedImages = [];
        let attachedDocsText = ""; 
        const MAX_IMAGES = 12; 
        let currentPlanData = null; // Almacenar√° el JSON del examen
        let quotaPollInterval = null;

        // --- PART√çCULAS DEL FONDO ---
        const symbols = ['?', '!', 'A+', 'Test', '100%', 'Eval', 'Nota', 'Firma', '√çtem', 'Examen', 'Quiz'];

        function initAllParticles() {
            const containers = document.querySelectorAll('.particles-container');
            containers.forEach(container => {
                container.innerHTML = '<div class="grid-overlay"></div>';
                createParticlesForContainer(container);
            });
        }

        function createParticlesForContainer(container) {
            const particleCount = 18; 
            for (let i = 0; i < particleCount; i++) {
                const span = document.createElement('span');
                span.textContent = symbols[Math.floor(Math.random() * symbols.length)];
                span.classList.add('grade-particle');
                if (Math.random() > 0.5) span.classList.add('primary-teal');
                else span.classList.add('secondary-teal');
                const rotation = Math.floor(Math.random() * 40 - 20);
                span.style.setProperty('--rotation', `${rotation}deg`);
                span.classList.add('background');
                const left = Math.random() * 100;
                const duration = 15 + Math.random() * 20; 
                const delay = Math.random() * -30; 
                const size = 0.8 + Math.random() * 1.2; 
                span.style.left = `${left}%`;
                span.style.animationDuration = `${duration}s`;
                span.style.animationDelay = `${delay}s`;
                span.style.fontSize = `${size}rem`;
                container.appendChild(span);
            }
        }
        
        // --- SISTEMA DE LOGIN Y SESI√ìN ---

        window.onload = function() {
            initAllParticles();
            checkSession();
        };

        function checkSession() {
            const session = sessionStorage.getItem('pinceladas_session');
            const loader = document.getElementById('initial-loader');

            if (session) {
                const data = JSON.parse(session);
                loginUserSuccess(data.name, data.usernameUnique, true);
            } else {
                setTimeout(() => {
                    loader.classList.add('opacity-0');
                    setTimeout(() => loader.classList.add('hidden'), 700);
                }, 1000);
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const btn = document.getElementById('btn-login');
            const btnText = document.getElementById('btn-text');
            const loader = document.getElementById('btn-loader');
            const statusBox = document.getElementById('login-status-container');
            const statusText = document.getElementById('login-status-text');

            btnText.classList.add('hidden-text'); 
            loader.classList.remove('hidden');
            btn.disabled = true;
            
            statusBox.className = "min-h-[40px] transition-all duration-300 rounded-lg flex items-center justify-center gap-2 border px-2 py-1 bg-montessori-lightBlue border-montessori-lightBlue/50";
            statusText.className = "text-xs font-bold text-montessori-blue";
            statusText.innerText = "Verificando credenciales...";

            try {
                const response = await fetch(`${API_URL}?action=login&username=${encodeURIComponent(user.trim())}&password=${encodeURIComponent(pass.trim())}`, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: {
                        "Content-Type": "text/plain;charset=utf-8"
                    }
                });
                const data = await response.json();

                if (data.success) {
                    const sessionData = {
                        name: data.name,
                        usernameUnique: data.usernameUnique,
                        loginTime: new Date().getTime()
                    };
                    sessionStorage.setItem('pinceladas_session', JSON.stringify(sessionData));
                    
                    userQuota.remaining = data.quota.remaining;
                    userQuota.total = data.quota.limit;

                    loginUserSuccess(data.name, data.usernameUnique, false);

                } else {
                    throw new Error(data.error || "Credenciales incorrectas o error en servidor");
                }
            } catch (error) {
                console.error(error);
                statusBox.className = "min-h-[40px] transition-all duration-300 rounded-lg flex items-center justify-center gap-2 border px-2 py-1 bg-red-50 border-red-200";
                statusText.className = "text-xs font-bold text-red-600";
                statusText.innerText = error.message;
                btnText.classList.remove('hidden-text');
                loader.classList.add('hidden');
                btn.disabled = false;
            }
        }

        function showAccessDeniedModal() {
            const modal = document.getElementById('access-denied-modal');
            if(modal) modal.classList.remove('hidden');
        }

        // --- L√ìGICA MODAL EST√ÅTICO DE CUPO ---
        function showQuotaExceededModal() {
            const modal = document.getElementById('quota-exceeded-modal');
            if(modal.classList.contains('hidden')) {
                const now = new Date();
                const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('reset-date-display').innerText = nextMonth.toLocaleDateString('es-ES', options);

                modal.classList.remove('hidden');
                
                const btnGen = document.getElementById('btn-generate');
                const btnMod = document.getElementById('btn-modify');
                if(btnGen) btnGen.classList.add('disabled-btn');
                if(btnMod) btnMod.classList.add('disabled-btn');
            }
        }

        function loginUserSuccess(name, usernameUnique, isAutoLogin) {
            currentUser = usernameUnique;
            document.getElementById('user-name-display').innerText = name; 
            const loginScreen = document.getElementById('login-screen');
            const loader = document.getElementById('initial-loader');
            const appContent = document.getElementById('app-content');

            loginScreen.classList.add('fade-out');
            setTimeout(() => loginScreen.classList.add('hidden'), 500);
            
            if(!isAutoLogin) {
                 loader.classList.add('hidden');
            } else {
                refreshQuota(usernameUnique);
                loader.classList.add('opacity-0');
                setTimeout(() => loader.classList.add('hidden'), 700);
            }

            if (userQuota.remaining <= 0 && userQuota.total > 0) {
                 showQuotaExceededModal();
            }

            appContent.classList.remove('hidden');
            setTimeout(() => {
                appContent.classList.remove('opacity-0');
                updateQuotaDisplay();
            }, 100);

            if (quotaPollInterval) clearInterval(quotaPollInterval);
            quotaPollInterval = setInterval(() => {
                if(currentUser) refreshQuota(currentUser);
            }, 30000); 
        }

        function logout() {
            sessionStorage.removeItem('pinceladas_session');
            if (quotaPollInterval) clearInterval(quotaPollInterval);
            location.reload();
        }

        async function refreshQuota(username) {
            try {
                const timestamp = new Date().getTime();
                const response = await fetch(`${API_URL}?action=checkQuota&username=${encodeURIComponent(username)}&t=${timestamp}`, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: {
                        "Content-Type": "text/plain;charset=utf-8"
                    }
                });
                
                if (!response.ok) throw new Error("Network response was not ok");
                
                const data = await response.json();
                
                if(data.success) {
                    userQuota.remaining = data.quota.remaining;
                    userQuota.total = data.quota.limit;
                    updateQuotaDisplay();
                    checkQuotaLimits(); 
                }
            } catch(e) { 
                console.warn("No se pudo actualizar la cuota:", e); 
            }
        }

        function updateQuotaDisplay() {
            const counter = document.getElementById('usage-counter');
            if(userQuota.total > 0) {
                counter.innerText = `${userQuota.remaining} / ${userQuota.total}`;
                if(userQuota.remaining <= 0) {
                    counter.className = "text-xs font-black text-red-500";
                } else {
                    counter.className = "text-xs font-black text-montessori-blue leading-none pt-[1px]";
                }
            } else {
                counter.innerText = "...";
            }
        }

        function checkQuotaLimits() {
            const btnGen = document.getElementById('btn-generate');
            const btnMod = document.getElementById('btn-modify');

            if (userQuota.remaining <= 0) {
                if(btnGen) {
                    btnGen.disabled = true;
                    btnGen.classList.add('disabled-btn');
                    btnGen.innerHTML = `<span class="relative z-10 flex items-center gap-2">L√çMITE ALCANZADO</span>`;
                }
                if(btnMod) {
                    btnMod.disabled = true;
                    btnMod.classList.add('disabled-btn');
                }
                showQuotaExceededModal(); 
            } else {
                if(btnGen && btnGen.disabled) {
                    btnGen.disabled = false;
                    btnGen.classList.remove('disabled-btn');
                    btnGen.innerHTML = `<span class="relative z-10 flex items-center gap-2">GENERAR EVALUACI√ìN</span><div class="absolute inset-0 h-full w-full scale-0 rounded-2xl transition-all duration-300 group-hover:scale-100 group-hover:bg-white/10"></div>`;
                }
                if(btnMod && btnMod.disabled) {
                    btnMod.disabled = false;
                    btnMod.classList.remove('disabled-btn');
                }
            }
        }

        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.innerText = message;
            toast.className = "show";
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }

        // Funci√≥n obsoleta (Eliminada en el HTML)
        /*
        function selectDays(count) {
            selectedExercisesCount = count;
            document.getElementById('selectedDays').value = count;
            for (let i = 1; i <= 5; i++) {
                const btn = document.getElementById(`day-${i}`);
                if (btn) {
                    if (i === count) btn.classList.add('active');
                    else btn.classList.remove('active');
                }
            }
        }
        */

        function handleTemplateSelect(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('template-name').textContent = file.name;
                showToast("Plantilla cargada exitosamente");
            }
        }

        // --- MANEJO DE ARCHIVOS ---
        async function handleFileUpload(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            const uploadArea = document.getElementById('upload-area');
            const originalText = uploadArea.innerHTML;
            uploadArea.innerHTML = '<span class="text-xs text-montessori-blue font-bold animate-pulse">Procesando...</span>';

            for (const file of files) {
                if (file.type.startsWith('image/')) {
                    if (attachedImages.length >= MAX_IMAGES) { showToast("L√≠mite de im√°genes alcanzado"); continue; }
                    try { const base64 = await compressImage(file, 800, 0.7); attachedImages.push(base64); } catch(e){ console.error(e); }
                } else if (file.type === 'application/pdf') {
                    try { 
                        const text = await extractTextFromPDF(file); 
                        attachedDocsText += `\n\n--- CONTENIDO PDF (${file.name}) ---\n${text.substring(0, 15000)}... [Truncado]`; 
                        renderDocPreview(file.name, 'PDF');
                    } catch(e){ showToast("Error leyendo PDF"); }
                } else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                    try {
                        const text = await extractTextFromDocx(file);
                        attachedDocsText += `\n\n--- CONTENIDO DOCX (${file.name}) ---\n${text.substring(0, 15000)}... [Truncado]`; 
                        renderDocPreview(file.name, 'DOCX');
                    } catch(e){ showToast("Error leyendo DOCX"); }
                }
            }
            renderImagePreviews();
            uploadArea.innerHTML = originalText;
            event.target.value = "";
        }

        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
            let fullText = "";
            const maxPages = Math.min(pdf.numPages, 5); 
            for (let i = 1; i <= maxPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                fullText += textContent.items.map(item => item.str).join(" ") + "\n";
            }
            return fullText;
        }

        async function extractTextFromDocx(file) {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({arrayBuffer: arrayBuffer});
            return result.value; 
        }

        function renderImagePreviews() {
            const grid = document.getElementById('images-grid');
            const uploadArea = document.getElementById('upload-area');
            const counter = document.getElementById('img-count');
            grid.innerHTML = ''; 
            if (attachedImages.length > 0) {
                grid.classList.remove('hidden');
                uploadArea.classList.remove('hidden'); 
                attachedImages.forEach((base64, index) => {
                    const div = document.createElement('div');
                    div.className = "relative group rounded-lg overflow-hidden border border-gray-200 aspect-square";
                    div.innerHTML = `<img src="${base64}" class="w-full h-full object-cover"><button onclick="removeImage(${index})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>`;
                    grid.appendChild(div);
                });
            } else { grid.classList.add('hidden'); uploadArea.classList.remove('hidden'); }
            counter.innerText = `${attachedImages.length}/${MAX_IMAGES}`;
        }

        function renderDocPreview(name, type) {
            const list = document.getElementById('docs-list');
            const item = document.createElement('div');
            item.className = "text-xs bg-gray-100 p-2 rounded flex justify-between items-center";
            item.innerHTML = `<span class="truncate font-bold text-gray-700">[${type}] ${name}</span>`;
            list.appendChild(item);
        }

        function removeImage(index) { attachedImages.splice(index, 1); renderImagePreviews(); }
        
        function compressImage(file, maxWidth, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = event => { const img = new Image(); img.src = event.target.result; img.onload = () => { const canvas = document.createElement('canvas'); let w = img.width; let h = img.height; if (w > maxWidth) { h = Math.round((h * maxWidth) / w); w = maxWidth; } canvas.width = w; canvas.height = h; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h); resolve(canvas.toDataURL('image/jpeg', quality)); }; img.onerror = reject; }; reader.onerror = reject;
            });
        }

        // --- MODALS ---
        function toggleInstructionsModal() { document.getElementById('instructions-modal').classList.toggle('hidden'); }
        function saveInstructions() {
            const input = document.getElementById('instructions-input');
            const hiddenField = document.getElementById('customInstructions');
            const btn = document.getElementById('btn-instructions');
            const btnText = document.getElementById('btn-instructions-text');
            hiddenField.value = input.value.trim();
            toggleInstructionsModal();
            const count = attachedImages.length + (attachedDocsText ? 1 : 0);
            const hasText = hiddenField.value.length > 0;
            if (hasText || count > 0) {
                btn.className = "w-full py-2.5 px-3 rounded-lg bg-montessori-blue text-white border border-transparent shadow-md hover:bg-[#123145] transition-all duration-300 flex items-center justify-center gap-2 group mt-1";
                btnText.textContent = `Contexto (${count}) + Nota`;
            } else {
                btn.className = "w-full py-2.5 px-3 rounded-lg bg-gray-50 border border-dashed border-gray-300 text-gray-600 hover:text-montessori-blue hover:border-montessori-blue hover:bg-montessori-lightBlue transition-all duration-300 flex items-center justify-center gap-2 group mt-1";
                btnText.textContent = "Contexto / Archivos";
            }
        }

        function toggleModificationModal() { 
            if (userQuota.remaining <= 0) {
                showQuotaExceededModal();
                return;
            }
            document.getElementById('modification-modal').classList.toggle('hidden'); 
        }
        
        async function applyModification() {
            if (userQuota.remaining <= 0) {
                showQuotaExceededModal();
                toggleModificationModal(); 
                return;
            }

            const request = document.getElementById('modification-input').value;
            if(!request) return;
            toggleModificationModal();
            showToast("Aplicando correcciones pedag√≥gicas...");
            await generatePlan(null, true, request);
        }

        // --- DROPDOWNS ---
        function toggleDropdown(type) {
            const list = document.getElementById(`${type}-dropdown-list`);
            const chevron = document.getElementById(`${type}-chevron`);
            if (list) {
                list.classList.toggle('hidden');
                if(chevron) chevron.classList.toggle('rotate-180');
            }
        }
        function selectDropdownValue(type, value) {
            if(type === 'style') {
                document.getElementById('teachingStyle').value = value;
                const textSpan = document.getElementById('selected-style-text');
                textSpan.textContent = value;
                textSpan.classList.remove('text-gray-500', 'font-normal');
                textSpan.classList.add('text-gray-900', 'font-medium');
            }
            document.getElementById(`${type}-dropdown-list`).classList.add('hidden');
            const chevron = document.getElementById(`${type}-chevron`);
            if(chevron) chevron.classList.remove('rotate-180');
        }

        document.addEventListener('click', function(e) {
            if(!e.target.closest('.custom-select-container')) {
                document.querySelectorAll('.custom-dropdown-list').forEach(list => {
                    list.classList.add('hidden');
                });
                document.querySelectorAll('[id$="-chevron"]').forEach(c => c.classList.remove('rotate-180'));
            }
        });

        // --- CORE: GENERACI√ìN DE EXAMEN (L√ìGICA NUEVA) ---
        async function fetchWithRetry(url, options, retries = 3, delay = 2000) {
            let lastError;
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 503 || response.status === 429) throw new Error("HTTP_OVERLOAD");
                    const clone = response.clone();
                    try { const data = await clone.json(); if (data.success === false && (data.error||"").toLowerCase().includes("overloaded")) throw new Error("LOGICAL_OVERLOAD"); } catch (e) {}
                    return response; 
                } catch (err) {
                    lastError = err;
                    if (i === retries - 1) throw err;
                    const loaderSubtitle = document.querySelector('#loader p');
                    if (loaderSubtitle) loaderSubtitle.innerText = `Reintentando conexi√≥n con servidor (${i+1}/${retries})...`;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 1.5; 
                }
            }
            if (lastError) throw lastError;
        }

        async function generatePlan(e, isModification = false, modificationRequest = "") {
            if(e) e.preventDefault();
            
            if (userQuota.remaining <= 0) { 
                showQuotaExceededModal(); 
                return; 
            }

            const subject = document.getElementById('subject').value;
            const groupDetails = document.getElementById('groupDetails').value;
            const tone = document.getElementById('teachingStyle').value || "Acad√©mico";
            const topics = document.getElementById('topics').value;
            // Nuevo: Leer del input number
            const totalExercises = parseInt(document.getElementById('totalExercisesInput').value || 1);
            const itemsPerExercise = document.getElementById('itemsPerExercise').value || 5;
            const exerciseTypes = document.getElementById('exerciseTypes').value || "Variados";
            const extraInstructions = document.getElementById('customInstructions').value;

            if (totalExercises < 1) {
                showToast("La cantidad de ejercicios debe ser 1 o m√°s.");
                document.getElementById('totalExercisesInput').focus();
                return;
            }

            // --- PROMPT DE EVALUACI√ìN (ACTUALIZADO CON REGLAS DE FORMATO) ---
            let baseInstruction = `
            Act√∫a como un profesor experto en pedagog√≠a y dise√±o curricular.
            Tu tarea es redactar una Evaluaci√≥n Escrita Formal para la asignatura de ${subject}, dirigida al curso/nivel de ${groupDetails}.

            Configuraci√≥n de la Evaluaci√≥n:

            Temas a evaluar:
            ${topics}

            Estructura y Cantidad:
            Genera un total de ${totalExercises} ejercicios/preguntas grandes.
            Cada ejercicio debe contener aprox ${itemsPerExercise} √≠tems o sub-preguntas internas si aplica.
            Tipos de ejercicios a utilizar: ${exerciseTypes}.
            Instrucci√≥n de dise√±o: Debes alternar estrictamente entre los tipos de ejercicios mencionados en orden secuencial si es posible.

            Tono y Lenguaje:
            El lenguaje debe ser ${tone} y estrictamente ajustado al nivel cognitivo de un estudiante de ${groupDetails}.
            Evita jerga innecesariamente compleja si no corresponde al nivel, pero mant√©n el rigor acad√©mico.

            Reglas Estrictas de Formato (Constraints):
            Indicaciones: Las consignas de cada ejercicio deben ser extremadamente claras, directas y concisas (imperativas).
            Prohibido: NO incluyas ejemplos de c√≥mo resolver el ejercicio dentro de las instrucciones. NO a√±adas introducciones motivacionales ni texto de relleno ("fluff"). NO uses asteriscos (*) o par√©ntesis para aclaraciones o respuestas.
            Sin Solucionario: Genera √∫nicamente la hoja para el estudiante. NO incluyas las respuestas correctas.
            Formato de Contenido: El contenido de las preguntas (campo "contenido") debe usar estrictamente formato de lista numerada (1., 2., 3., etc.) if hay √≠tems.

            REGLAS MATEM√ÅTICAS ESTRICTAS (Solo texto sin formato):
            1. Exponentes: Para potencias, utiliza la notaci√≥n de **caret (^) seguida por el exponente o la expresi√≥n del exponente encerrada en par√©ntesis**. Ejemplo: 5^x o (2x)^3.
               **CR√çTICO:** Est√° prohibido usar el s√≠mbolo de d√≥lar ($) o cualquier comando de LaTeX como \frac o \sqrt. El contenido debe ser texto simple y claro.
            2. Operaciones Complejas: Usa par√©ntesis ( ), corchetes [ ], y/o llaves { } de manera estricta y anidada para diferenciar el orden de las operaciones internas y separar claramente los componentes de ejercicios largos. Prioriza la claridad. Ejemplo: [ (a+b) / (c) ] * 2.
            3. Fracciones: Usa el s√≠mbolo de barra (/) para representar fracciones. Aseg√∫rate de que el numerador y el denominador compuestos est√©n siempre encerrados en par√©ntesis. Ejemplo: (x+3)/(y-1).

            ${attachedDocsText ? "CONTEXTO ADICIONAL (Basarse en estos textos): " + attachedDocsText : ""}
            ${extraInstructions ? "Instrucciones Extra: " + extraInstructions : ""}

            FORMATO DE SALIDA (JSON STRICTO):
            Responde √öNICAMENTE con un objeto JSON v√°lido.
            La estructura debe ser:
            {
              "ejercicios": [
                 {
                   "numero": 1,
                   "tipo": "Tipo de ejercicio (ej: Selecci√≥n M√∫ltiple)",
                   "consigna": "Texto de la instrucci√≥n clara y directa.",
                   "contenido": "Texto con las preguntas, items, espacios en blanco o contenido del ejercicio. Usar listas numeradas (1., 2., etc.)"
                 },
                 ... hasta ${totalExercises}
              ]
            }
            `;

            let finalPrompt = "";
            if (isModification && currentPlanData) {
                baseInstruction += `\n\nEXAMEN ACTUAL (JSON): ${JSON.stringify(currentPlanData)}`;
                finalPrompt = `El usuario quiere modificar el examen actual con esta solicitud: "${modificationRequest}". Genera el nuevo JSON completo con los cambios aplicados, manteniendo la estructura.`;
            } else {
                finalPrompt = `Generar Evaluaci√≥n de ${totalExercises} ejercicios para ${subject}.`;
            }

            document.getElementById('loader').classList.remove('hidden');
            if(!isModification) {
                document.getElementById('result-placeholder').classList.add('hidden');
                document.getElementById('result-content').classList.add('hidden');
            }
            document.getElementById('btn-generate').disabled = true;

            try {
                // LLAMADA 1: Generaci√≥n de contenido (IA)
                const payload = { prompt: finalPrompt, systemInstruction: baseInstruction };
                if (attachedImages.length > 0) payload.images = attachedImages;

                const response = await fetchWithRetry(API_GEN_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error("Error HTTP: " + response.status);
                const data = await response.json();
                if(!data.success) throw new Error(data.error || "Error desconocido.");

                let cleanText = data.text.replace(/```json/gi, '').replace(/```/g, '').trim();
                const start = cleanText.indexOf('{');
                const end = cleanText.lastIndexOf('}');
                if (start === -1) throw new Error("No se encontr√≥ un bloque JSON v√°lido.");
                let jsonCandidate = end > start ? cleanText.substring(start, end + 1) : cleanText.substring(start);
                
                try {
                    currentPlanData = JSON5.parse(jsonCandidate);
                } catch (e) {
                    console.warn("Reparando JSON...", e);
                    // Intento simple de reparaci√≥n
                    try { currentPlanData = JSON5.parse(jsonCandidate + "]}"); } 
                    catch(err){ throw new Error("Error procesando respuesta del sistema."); }
                }

                renderEditor(currentPlanData);

                // 2. DESCUENTO DE CUOTA
                const timestamp = new Date().getTime();
                fetch(`${API_URL}?action=useQuota&username=${encodeURIComponent(currentUser)}&t=${timestamp}`, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { "Content-Type": "text/plain;charset=utf-8" }
                })
                .then(res => res.json())
                .then(regData => {
                    if(regData.success) { 
                        userQuota.remaining = regData.remaining;
                        updateQuotaDisplay();
                        checkQuotaLimits(); 
                    }
                })
                .catch(err => console.error("Error cuota:", err));

                document.getElementById('loader').classList.add('hidden');
                const resCont = document.getElementById('result-content');
                resCont.classList.remove('hidden');
                resCont.classList.add('flex');
                requestAnimationFrame(() => resCont.classList.remove('translate-y-4', 'opacity-0'));
                
                document.getElementById('btn-modify').classList.remove('hidden');
                document.getElementById('btn-download-word').classList.remove('hidden');

            } catch (error) {
                console.error("ERROR:", error);
                document.getElementById('loader').classList.add('hidden');
                if(!isModification) document.getElementById('result-placeholder').classList.remove('hidden');
                showToast("Error: " + error.message);
            } finally {
                if(userQuota.remaining > 0) {
                    document.getElementById('btn-generate').disabled = false;
                } else {
                    checkQuotaLimits();
                }
            }
        }

        // --- RENDERIZADO DEL EDITOR DE EXAMEN ---
        function renderEditor(data) {
            const container = document.getElementById('editor-container');
            container.innerHTML = '';
            
            const ejercicios = data.ejercicios || [];
            if(ejercicios.length === 0) {
                 container.innerHTML = '<p class="text-red-500 p-4">Error en formato de respuesta. Intente de nuevo.</p>';
                 return;
            }

            ejercicios.forEach((ejercicio, index) => {
                const card = document.createElement('div');
                card.className = 'plan-card';
                card.innerHTML = `
                    <div class="day-header">
                        <span>EJERCICIO ${index + 1}</span>
                        <span class="text-xs font-normal bg-montessori-lightBlue text-montessori-blue px-2 py-1 rounded normal-case">${ejercicio.tipo || 'General'}</span>
                    </div>
                    
                    <label class="section-label">Consigna / Instrucciones</label>
                    <textarea id="consigna_${index+1}" class="editable-field" style="height: 4rem;">${ejercicio.consigna || ''}</textarea>
                    
                    <label class="section-label">Contenido / Preguntas (Usar formato de lista numerada)</label>
                    <textarea id="contenido_${index+1}" class="editable-field" style="height: 12rem;">${ejercicio.contenido || ''}</textarea>
                `;
                container.appendChild(card);
            });
        }

        function getValueOrEmpty(id) {
            const el = document.getElementById(id);
            return el ? el.value || '' : '';
        }

        // --- EXPORTAR A WORD (L√ìGICA EVALUACI√ìN) ---
        function downloadWord() {
            const fileInput = document.getElementById('template-upload');
            const btn = document.getElementById('btn-download-word');

            if (fileInput.files.length === 0) { showToast("Sube tu plantilla .docx primero"); return; }

            btn.classList.add('animate-success-feedback');
            setTimeout(() => { btn.classList.remove('animate-success-feedback'); }, 300);

            // Construir objeto plano para el Word
            const finalData = {
                asignatura: getValueOrEmpty('subject'),
                curso: getValueOrEmpty('groupDetails'),
                tema: getValueOrEmpty('topics'),
            };

            // Iterar hasta 40 posibles ejercicios para llenar los tags (L√≠mite m√°ximo para tags de Word)
            for(let i=1; i<=40; i++) {
                finalData[`consigna_${i}`] = getValueOrEmpty(`consigna_${i}`);
                finalData[`contenido_${i}`] = getValueOrEmpty(`contenido_${i}`);
            }

            const reader = new FileReader();
            reader.readAsArrayBuffer(fileInput.files[0]);

            reader.onload = function(evt) {
                try {
                    const content = evt.target.result;
                    const zip = new PizZip(content);
                    
                    const doc = new window.docxtemplater(zip, { 
                        paragraphLoop: true, 
                        linebreaks: true,
                        nullGetter: function(part) { return ""; } 
                    });
                    
                    doc.render(finalData);
                    
                    const out = doc.getZip().generate({
                        type: "blob",
                        mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                    });
                    
                    const abbreviate = (text) => {
                        if (!text) return "EXAMEN";
                        // Usar solo la primera palabra o las primeras 5 letras de la primera
                        const word = text.split(/\s+/)[0];
                        return word ? word.substring(0, 5).toUpperCase() : "EXAMEN";
                    };

                    const cursoAbrev = abbreviate(getValueOrEmpty('groupDetails'));
                    saveAs(out, `Evaluacion-${cursoAbrev}.docx`);
                    showToast("¬°Evaluaci√≥n descargada!");
                } catch (error) {
                    console.error("Error Word:", error);
                    showToast("Error generando Word. Revisa los tags.");
                }
            };
        }
    </script>
</body>
</html>
